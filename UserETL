from oauth2client.service_account import ServiceAccountCredentials
from googleapiclient.discovery import build
import httplib2
import pandas as pd
import numpy as np

#Create service credentials
#Rename your JSON key to client_secrets.json and save it to your working folder
credentials = ServiceAccountCredentials.from_json_keyfile_name('client_secrets.json', ['https://www.googleapis.com/auth/analytics.readonly'])

#Create a service object
http = credentials.authorize(httplib2.Http())
service = build('analytics', 'v4', http=http, discoveryServiceUrl=('https://analyticsreporting.googleapis.com/$discovery/rest'))
response = service.reports().batchGet(
    body={
        'reportRequests': [
            {
                'viewId': '269455217',
                'dateRanges': [{'startDate': '30daysAgo', 'endDate': 'today'}],
                'metrics': [{'expression': 'ga:users'}], 
                'dimensions': [{"name": "ga:hour"}], 
                # "filtersExpression":"ga:pagePath=~products;ga:pagePath!@/translate",
                'orderBys': [{"fieldName": "ga:users", "sortOrder": "DESCENDING"}], 
                'pageSize': 100
            }]
    }
).execute()

#Create two empty lists that will hold our dimentions and users data
dim = []
val = []

#Extract Data
for report in response.get('reports', []):
  
    columnHeader = report.get('columnHeader', {})
    dimensionHeaders = columnHeader.get('dimensions', [])
    metricHeaders = columnHeader.get('metricHeader', {}).get('metricHeaderEntries', [])
    rows = report.get('data', {}).get('rows', [])
  
    for row in rows:
  
        dimensions = row.get('dimensions', [])
        dateRangeValues = row.get('metrics', [])
  
        for header, dimension in zip(dimensionHeaders, dimensions):
            dim.append(int(dimension))
  
        for i, values in enumerate(dateRangeValues):
            for metricHeader, value in zip(metricHeaders, values.get('values')):
                val.append(int(value))

#Sort Data

val.reverse()
dim.reverse()

print(val)
print(dim)

df = pd.DataFrame() 
df["Session"] = val
df["Users"] = dim
df = df[["Users","Session"]]
df

# print(df)
#Export to CSV
df.to_csv("users.csv")

my_list = df.columns.values.tolist()
print(my_list)
